<!doctype html><html lang=en><head><meta charset=utf-8><title>Usenir.com</title><meta name=description content=usenir.com><meta name=author content=usenir.com><meta name=viewport content="width=device-width, initial-scale=1"><style>:root{--c-fg:hsl(0,0%,80%);--c-fg-weak:hsl(0,0%,45%);--c-fg-strong:hsl(0,0%,100%);--c-fg-alt:hsl(0,0%,70%);--c-heading:hsl(0,0%,75%);--c-bg:hsl(0,0%,0%);--c-bg-weak:hsl(0,0%,15%);--c-link:hsl(0,0%,70%);--c-link-hover:hsl(0,0%,100%);--c-button:hsl(209,75%,52%);--c-codehilite:hsl(209,75%,52%);--c-codehilite-bright:hsl(209,75%,60%);--c-codehilite-weak:hsl(209,75%,36%);--c-highlight-1-bright:hsl(223,100%,50%);--c-highlight-1:hsl(223,97%,65%);--c-highlight-2:hsl(159,66%,54%);--c-selection-fg:hsl(0,0%,0%);--c-selection-bg:hsl(300,2%,77%);--c-border:hsl(0,0%,25%);--c-shadow:hsl(0,0%,67%);--c-note-fg:#0ff;--c-note-bg:#033;--c-note-border:#066;--c-danger-fg:#f00;--c-danger-bg:#300;--c-danger-border:#600;--c-important-fg:#ff0;--c-important-bg:#330;--c-important-border:#660;--font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;--font-size:16px;--max-width:768px}*{box-sizing:border-box}.scrollbar-thin{scrollbar-width:thin}::selection{color:var(--c-selection-fg);background-color:var(--c-selection-bg)}html{scrollbar-color:var(--c-fg) var(--c-border);margin:0}body{color:var(--c-fg);background-color:var(--c-bg);font-size:var(--font-size);font-family:var(--font-family);line-height:1.5;margin:0;margin-left:auto;margin-right:auto;font-weight:light}.container{max-width:var(--max-width)}.row{width:100%}@media(min-width:768px){body{width:87.5%;padding-left:12.5%;max-width:1400px}.row{display:table;table-layout:fixed}.col{display:table-cell}.\31{width:calc(100%*1/10)}.\32{width:calc(100%*2/10)}.\33{width:calc(100%*3/10)}.\34{width:calc(100%*4/10)}.\35{width:calc(100%*5/10)}.\36{width:calc(100%*6/10)}.\37{width:calc(100%*7/10)}.\38{width:calc(100%*8/10)}.\39{width:calc(100%*9/10)}.\31{width:calc(100%*1/10)}.\31\30{width:calc(100%)}}.margin-l{margin-left:0.5rem}.margin-r{margin-right:0.5rem}.margin-t{margin-top:0.5rem}.margin-b{margin-bottom:0.5rem}.pad-l{padding-left:1em}.pad-r{padding-right:1em}.pad-t{padding-top:1em}.pad-b{padding-bottom:1em}.shadow{box-shadow:2px 2px 5px rgba(0,0,0,.5)}.shadow-strong{box-shadow:2px 2px 8px rgba(0,0,0,.8)}.rounded{border-radius:0.5rem}.scroll-x{overflow-x:auto}.scroll-y{overflow-y:auto}.break{word-break:break-all}.float-l{float:left}.float-r{float:right}.clear{clear:both}.width-100{width:100%}.hidden{display:none}.page--title,h1,h2,h3,h4,h5,h6{font-family:serif}.page--title{color:var(--c-heading);font-weight:400;margin-top:2rem;margin-bottom:1rem;font-size:36px;line-height:1;text-align:center;display:block}.page--description{font-style:italic;text-align:center;display:block}h1{color:var(--c-heading);font-weight:400;margin-top:64px;margin-bottom:24px;font-size:36px;line-height:1;border-bottom:1px solid var(--c-fg)}.markdown-body h1{text-align:right}h2{color:var(--c-heading);font-style:italic;font-weight:400;margin-top:34px;margin-bottom:22px;font-size:28px;line-height:1;border-bottom:1px dotted var(--c-fg-weak)}h3{color:var(--c-heading);font-style:italic;font-weight:400;font-size:20px;margin-top:20px;margin-bottom:22px;line-height:1;border-bottom:1px dotted var(--c-fg-weak)}.big{font-size:2em}.small{font-size:0.8em}.weak{color:var(--c-fg-weak)}.text-center{text-align:center}.strong{font-weight:bold}blockquote{border-top:1px solid var(--c-border);border-bottom:1px solid var(--c-border);background:linear-gradient(90deg,var(--c-bg) 0%,var(--c-bg-weak) 50%,var(--c-bg) 100%);padding:1em 1.25em;margin:1.625em 0 1.75em 0;font-style:italic}p{text-align:justify;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.admonition{padding-bottom:0.5em;margin:1.625em 0 1.75em 0}.admonition>p{margin:0;padding-left:1em;padding-right:1em}.admonition-title{padding-top:0.5em;padding-bottom:0.5em;color:var(--c-fg-strong)}.note{background-color:var(--c-note-bg);border:1px solid var(--c-note-border)}.note .admonition-title::before{content:"Note:\2006";color:var(--c-note-fg);font-family:monospace}.danger{border:1px solid var(--c-danger-border);background-color:var(--c-danger-bg)}.danger .admonition-title::before{content:"Danger:\2006";color:var(--c-danger-fg);font-family:monospace}.important{border:1px solid var(--c-important-border);background-color:var(--c-important-bg)}.important .admonition-title::before{content:"Important:\2006";color:var(--c-important-fg);font-family:monospace}.container--metadata{padding-top:0.5em;font-size:0.8em;font-style:italic;text-align:center;color:var(--c-fg-weak)}a{color:var(--c-link)}a:hover{color:var(--c-link-hover)}.nav{display:block;width:100%;margin:0.75rem auto;font-family:monospace;background:radial-gradient(3rem 1.5rem at 5rem top,var(--c-fg-weak),var(--c-bg))}.nav::before{content:"";display:block;height:0.15rem;background:linear-gradient(90deg,var(--c-bg) 0%,var(--c-fg-strong) 3rem,var(--c-bg) 100%)}.nav a{text-decoration:none;padding:0.5rem 0.5rem;display:inline-block;margin:0;font-size:1.1em;border-bottom:none;color:#999}.nav a:hover{color:var(--c-link-hover)}.logo{color:var(--c-fg-strong)!important;font-size:1.5rem!important}.animate-flicker{-webkit-animation:flickerAnimation .5s infinite;-moz-animation:flickerAnimation .5s infinite;-o-animation:flickerAnimation .5s infinite;animation:flickerAnimation .5s infinite}@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}hr{border:none;overflow:visible;height:0.15rem;background-color:var(--c-fg-alt);background:linear-gradient(90deg,hsl(0,0%,0%,0) 0%,hsl(0,0%,30%) 10%,hsl(0,0%,80%) 30%,hsl(0,0%,30%) 50%,hsl(0,0%,0%,0) 100%);color:#fff;margin:3rem 0}hr::after{content:"///";text-shadow:1px 1px #000;display:inline-block;position:relative;padding-left:30%;top:-0.6rem;font-size:0.8rem;background:#00000000}button{border:none;font-family:monospace;background:var(--c-highlight-1-bright);color:#fff;font-weight:bold;padding:1rem 2rem}button:hover{opacity:0.9;transition-duration:0.15s}button:active{opacity:0.5;transition-duration:0.15s}button:disabled{opacity:0.3}.active{background-color:var(--c-codehilite);color:var(--c-bg)}.index-item{text-decoration:none;width:100%;display:block;padding:3px 0;color:var(--c-fg)}.index-item:hover{background:var(--c-bg-weak);background:linear-gradient(90deg,hsla(0,0%,0%,0) 0%,hsla(0,0%,20%,1) 10%,hsla(0,0%,0%,0) 90%)}pre{font-family:monospace;max-width:var(--max-width);overflow:auto;padding:1em 1.25em;margin:1.625em 0 1.75em 0;background-color:var(--c-bg-weak);border:1px solid var(--c-border)}table{border-collapse:collapse;border:1px solid var(--c-border)}th{background-color:var(--c-bg-weak);font-weight:bold;text-align:left;border-top:1px solid var(--c-border);border-bottom:1px solid var(--c-border);padding:0.25rem 0.25rem;border-right:1px solid var(--c-border)}td{padding:0.25rem 0.25rem;border-right:1px solid var(--c-border)}tr:nth-child(even){background-color:var(--c-bg-weak)}.toc{background-color:var(--c-bg-weak);padding:0.5em 1em;margin:0.5em 0}.toc a{text-decoration:none}.toc:empty{display:none}.toc ul{list-style-type:none;padding:0;margin:0;text-indent:0}.toc li{font-weight:bold;margin:5px 0 10px 0;padding-left:0.5em;position:relative;overflow-wrap:break-word}.toc ul ul{padding-left:0.7em}.toc li li{margin-bottom:0;font-weight:normal;font-size:0.9em}.toc>ul{counter-reset:ctr_toc_1}.toc>ul>li::before{counter-increment:ctr_toc_1;content:counter(ctr_toc_1) "\2006  ";color:var(--c-fg-weak)}.toc>ul ul{counter-reset:ctr_toc_2}.toc>ul ul li::before{counter-increment:ctr_toc_2;content:counter(ctr_toc_1) "." counter(ctr_toc_2) "\2006  ";color:var(--c-fg-weak)}.toc>ul ul ul{counter-reset:ctr_toc_3}.toc>ul ul ul li::before{counter-increment:ctr_toc_3;content:counter(ctr_toc_1) "." counter(ctr_toc_2) "." counter(ctr_toc_3) "\2006  ";color:var(--c-fg-weak)}.codehilite .hll{background-color:#404040}.codehilite{background:#202020;color:#d0d0d0}.codehilite .c{color:#999999;font-style:italic}.codehilite .err{color:#a61717;background-color:#e3d2d2}.codehilite .esc{color:#d0d0d0}.codehilite .g{color:#d0d0d0}.codehilite .k{color:#6ab825;font-weight:bold}.codehilite .l{color:#d0d0d0}.codehilite .n{color:#d0d0d0}.codehilite .o{color:#d0d0d0}.codehilite .x{color:#d0d0d0}.codehilite .p{color:#d0d0d0}.codehilite .ch{color:#999999;font-style:italic}.codehilite .cm{color:#999999;font-style:italic}.codehilite .cp{color:#cd2828;font-weight:bold}.codehilite .cpf{color:#999999;font-style:italic}.codehilite .c1{color:#999999;font-style:italic}.codehilite .cs{color:#e50808;font-weight:bold;background-color:#520000}.codehilite .gd{color:#d22323}.codehilite .ge{color:#d0d0d0;font-style:italic}.codehilite .gr{color:#d22323}.codehilite .gh{color:#ffffff;font-weight:bold}.codehilite .gi{color:#589819}.codehilite .go{color:#cccccc}.codehilite .gp{color:#aaaaaa}.codehilite .gs{color:#d0d0d0;font-weight:bold}.codehilite .gu{color:#ffffff}.codehilite .gt{color:#d22323}.codehilite .kc{color:#6ab825;font-weight:bold}.codehilite .kd{color:#6ab825;font-weight:bold}.codehilite .kn{color:#6ab825;font-weight:bold}.codehilite .kp{color:#6ab825}.codehilite .kr{color:#6ab825;font-weight:bold}.codehilite .kt{color:#6ab825;font-weight:bold}.codehilite .ld{color:#d0d0d0}.codehilite .m{color:#3677a9}.codehilite .s{color:#ed9d13}.codehilite .na{color:#bbbbbb}.codehilite .nb{color:#24909d}.codehilite .nc{color:#447fcf}.codehilite .no{color:#40ffff}.codehilite .nd{color:#ffa500}.codehilite .ni{color:#d0d0d0}.codehilite .ne{color:#bbbbbb}.codehilite .nf{color:#447fcf}.codehilite .nl{color:#d0d0d0}.codehilite .nn{color:#447fcf}.codehilite .nx{color:#d0d0d0}.codehilite .py{color:#d0d0d0}.codehilite .nt{color:#6ab825;font-weight:bold}.codehilite .nv{color:#40ffff}.codehilite .ow{color:#6ab825;font-weight:bold}.codehilite .w{color:#666666}.codehilite .mb{color:#3677a9}.codehilite .mf{color:#3677a9}.codehilite .mh{color:#3677a9}.codehilite .mi{color:#3677a9}.codehilite .mo{color:#3677a9}.codehilite .sa{color:#ed9d13}.codehilite .sb{color:#ed9d13}.codehilite .sc{color:#ed9d13}.codehilite .dl{color:#ed9d13}.codehilite .sd{color:#ed9d13}.codehilite .s2{color:#ed9d13}.codehilite .se{color:#ed9d13}.codehilite .sh{color:#ed9d13}.codehilite .si{color:#ed9d13}.codehilite .sx{color:#ffa500}.codehilite .sr{color:#ed9d13}.codehilite .s1{color:#ed9d13}.codehilite .ss{color:#ed9d13}.codehilite .bp{color:#24909d}.codehilite .fm{color:#447fcf}.codehilite .vc{color:#40ffff}.codehilite .vg{color:#40ffff}.codehilite .vi{color:#40ffff}.codehilite .vm{color:#40ffff}.codehilite .il{color:#3677a9}</style></head><body><div class=container><div class=row><div class="col nav pad-l pad-r"><a class=logo href=../index.html>usenir.com</a><a href=#>about</a><a href=../index.html>home</a><a href=../index.html>tools</a><a href=../index.html>explorer</a><a href=../index.html>archive</a></div></div><div class="row pad-l pad-r"><div class=col><span class=page--title>Engineering stories</span><span class=page--description>Learning from others' mistakes</span></div></div><div class="row pad-l pad-r"><div class="col container--metadata"><span>tags:&nbsp</span><span class=metadata--value>markdown&nbsp</span><span class=metadata--value>cheatsheet&nbsp</span><br><span>01/12/2020 - 01/12/2020</span></div></div><div class=row><div class=col><div class=toc><ul><li><a href=#software>Software</a></li></ul></div></div></div><div class="row pad-l pad-r"><div class="col markdown-body"><h1 id=software>Software</h1><p>McLaren Stanley@ uber <a href=https://twitter.com/StanTwinB/status/1336890442768547845>twitter thread</a></p><ul><li>Alright folks, gather round and let me tell you the story of (almost) the biggest engineering disaster I’ve ever had the misfortune of being involved in. It’s a tale of politics, architecture and the sunk cost fallacy [I’m drinking an Aberlour Cask Strength Single Malt Scotch]</li><li>The year was 2016. Donald Trump was not yet the President therefore the #DeleteUber movement hadn’t happened yet. TK was still the CEO, we were still in the hyper growth phase of international rollout, public sentiment was overwhelmingly positive, Uber was riding high.</li><li>But hypergrowth is not without its problems, and the app itself was starting to show some cracks. The engineering org had doubled in sized almost every year prior, and when you grow that fast you end up with an incredibly wide range of skill. That paired with a hacking mentality</li><li>that we called “Let builder’s build”, meant that the app architecture was complicated and fragile. Uber at the time was extremely heavy on client side logic so the app would break a lot. We were constantly doing hot fixes, burning releases, etc. The design was also scaling badly.</li><li>As a consequence of all these problems, there began to be a growing movement across all levels of the org that was rallying around the idea of “rewriting the app from scratch” The general sentiment was that the architecture was slowing us down, starting over would be faster.</li><li>So a team was formed to build a new mobile architecture for this new app. The driving charter for the team was to build an architecture that would “sustain mobile development at Uber for the next 5 years”. We did both platforms at once. Product and Design also started over.</li><li>On the iOS side of the world, the rewrite presented an opportunity to adopt Swift (which was in version 2.x during this timespan). Uber had tried Swift before, but like many who had adopted it that early on it was extremely problematic so it had been banned prior to the rewrite.</li><li>But the general feeling of the architecture team was that most of Swift’s problems centered around the flakiness of the Objective-C interop back then so if we wrote a pure Swift app we could avoid the major issues.</li><li>There was also a push to use the same major architectural patterns on both Android and iOS. The android folks at the time were big RxJava fans, and there was an equivalent RxSwift library that took advantage of the functional programming paradigms in Swift. Seemed straightforward</li><li>So this smaller core team of Design, Product, and Architecture went off in a room for with their new functional/reactive patterns, new language, and new app for a few months. Everything went well. The architecture relied heavily on the advanced language features of Swift.</li><li>The UI design was scalable for the growing number of products that Uber offered, the functional programing paradigm was powerful (albeit a bit of a learning curve), the architecture centered around our new realtime stream based networking protocol (that’s the part I wrote).</li><li>After a few months and a number of flashy demos later the momentum was building. The project was looking like a success. They had built amazing experiences in a short time with a small number of engineers. Most of the core product was built out. The execs were sold.</li><li>So the company-wide rollout began. Teams began shifting all their focus to bringing their features to the new app. At first the excitement of the new created a flurry of motivation and productivity. The architecture was built for feature isolation which allowed teams to move fast</li><li>But once Swift started to scale past ten engineers the wheels started coming off. The Swift compiler is still much slower than Objective-C to then but back then it was practically unusable. Build times went though the roof. Typeahead/debugging stopped working entirely.</li><li>There’s a video somewhere in one of our talks of an Uber engineer typing a single line statement in Xcode and then waiting 45 seconds for the letter to appear in the editor slowly, one-by-one.</li><li>Then we hit a wall with the dynamic linker. At the time you could only link Swift libraries dynamically. Unfortunately the linker executed in polynomial time so Apple’s recommend maximum number of libraries in a single binary was 6. We had 92 and counting.</li><li>As a result It took 8-12 seconds after tapping the app icon before main was even called. Our shinny new app was slower than the old clunky one. Then the binary size problem hit.</li><li>But to answer @tapbot_paul’s original question, when the problems started showing up in earnest, we were already way past the point of no turning back (sunk cost fallacy). At this point the whole company was pouring its energy into the new app.</li><li>Thousands of people across every discipline, millions and millions (I can’t tell you the real number but it was way more than 1) of dollars had been spent. The whole management chain was fully bought in. I had privately had the “we need to stop” conversation with my director.</li><li>He told me that if this project fails he might as well pack his bags. The same was true for his boss all the way up to the VP. There was no way out.</li><li>So we rolled up our sleeves, and put our best people on each of the problems and prioritized the launch critical issues (dynamic linking, binary size). I was assigned to both dynamic linking and binary size in that order.</li><li>We quickly discovered that putting all of our code in the main executable solved the linking problem at App start up. But as we all know, Swift conflates namespacing with frameworks; so to do so would take a huge code change involving countless namespace checks.</li><li>That’s when the brilliant Richard Howell (not sure if he’s on Twitter) discovered while reading the Xcode build output that he could take all the intermediate object files and re-link them back into the main executable with a custom script after the build was complete.</li><li>Since Swift mangles the object namespace into the symbol name itself at compile time, this meant that he could safely preserve the namespacing while doing this. This allowed us to effectively static link our libraries and cut our pre-main time from 10 to basically 0.</li><li>Next problem: App Size. At the time we were planning to include the new app in the old app bundle and slowly roll it out at runtime as a safety net. First thing we did to buy space was to just remove the old app. We called this release strategy “Yolo”. TK himself made the call.</li><li>We also replaced <em>all</em> of our Swift structs with classes. Value types in general have a ton of overhead due to object flattening and the extra machine code needed for the copy behavior and auto-initializers etc. This saved us space so we pressed on.</li><li>But as the app kept growing. Soon we hit the cellar download limit (100 mb) for our universal binaries (iOS 8 and earlier). This represented a substantial amount of lost signups (it dollars it would cost us in the order of 8 figures of people who hadn’t upgraded yet).</li><li>At this point we were weeks away from the public launch date. We had graciously received help from a certain company that I’m still under NDA with, but they couldn’t solve our problem. The only thing we could do was regenerate all the model code (25% of the total line count)</li><li>back into Objective-C or drop support for iOS 8. Since iOS 9 had introduced individual architecture slicing it was affectively half the size (give or take). With only a week left we decided eat the 8 figures and drop support for iOS 8.</li><li>The general thinking was that at half the size we still had plenty of runway with the iOS 9 binary, and after the rewrite was done we could solve the problem sometime way down the road, because things would slow down a bit. We were unfortunately completely wrong about that.</li><li>After the app release we threw a huge party. The app was well received by the press. It was fast and snappy, with a flashy new design.</li><li>A bunch of people got promoted. We all breathed a sigh of relief. The 90 work weeks stopped for a few weeks.</li></ul><p>Replies:</p><ul><li>David A Smith: This so reminds me of when we were working with Taligent. They went all in on C++ templates for their frameworks. Even tiny apps were huge and compile times were so long you could go out to lunch. It was so frustrating and sad.<ul><li>McLaren Stanley: This is exactly right. The C++ templating problem is actually extremely similar. Very similar language concept, expensive for a lot of the same reasons.</li></ul></li></ul></div></div></div></body></html>