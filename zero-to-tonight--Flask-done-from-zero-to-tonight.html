<!doctype html>
<html lang=en>

<head>
    <meta charset=utf-8>
    <title>Flask done from zero to tonight</title>
    <meta name=description content=usenir.com>
    <meta name=author content=usenir.com>
    <meta name=viewport content="width=device-width, initial-scale=1">
    <!-- <link rel=stylesheet href="style.css"> -->
    <style>
        :root{--color-background:#ebecee;--color-foreground:#ffffff;--color-bg-dark:#aaa;--color-highlight-1:#4184f3;--color-highlight-light:#ff8a3c;--color-highlight-medium:#fa6400;--color-highlight-dark:#b64900;--color-highlight-bg:#ffdec8;--color-button-blue:#4184f3;--color-button-yellow:#ffd75b;--color-text-dark:#000;--color-text-medium:#43434d;--color-text-light:#6e757e;--color-border-medium:#ccc;--color-metadata:#6e757e;--font-san-serif:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Ubuntu","Roboto","Noto Sans","Droid Sans",sans-serif;--font-mono:ui-monospace,"Cascadia Mono","Segoe UI Mono","Ubuntu Mono","Roboto Mono",Menlo,Monaco,Consolas,monospace;--shadow-medium:rgba(0,0,0,0.1)}*,*:before,*:after{box-sizing:border-box}html{margin:0,padding 0;scroll-behavior:smooth}body{background-color:var(--color-background);font-family:Arial;padding:0 1rem 1rem 1rem;max-width:1400px;margin:auto;font-family:var(--font-san-serif);line-height:1.6}table{margin-top:1rem;display:block;overflow-y:auto;border-collapse:collapse}thead{background:var(--color-background);font-weight:bold;text-align:left}tr:nth-child(even){background-color:var(--color-background)}tr{border:1px solid var(--color-border-medium)}th,td{padding:3px 5px}hr{border:none;border-top:1px solid #6e757e}p{margin-bottom:.85rem}h1,h2,h3{font-weight:normal}a{color:var(--color-highlight-medium)}a:hover{background:var(--color-highlight-bg)!important;color:var(--color-text)!important}a:focus,button:focus{border:2px solid var(--color-highlight-medium)}blockquote{display:block;background-color:#eee;padding:1rem 2rem 1rem 2rem;margin:15px auto;color:#000;position:relative;text-align:center}blockquote::before{font-weight:400;font-style:normal;content:"\"";font-size:3rem;line-height:26px;position:absolute;top:20px;left:5px}blockquote::after{font-weight:400;font-style:normal;content:"\"";font-size:3rem;line-height:26px;position:absolute;bottom:0px;right:5px}img{max-width:100%;border-radius:0.75rem;display:block;margin:auto}h1{font-weight:400;margin-top:1.275rem;margin-bottom:.85rem}h2,h3{font-weight:400;margin-top:1.275rem;margin-bottom:.85rem}pre{padding:1rem 1rem;overflow-x:auto;background-color:var(--color-background);font-size:1rem;font-family:var(--font-mono);border:1px solid var(--color-border-medium)}code{background-color:var(--color-background)}.codehilitetable{background-color:var(--color-background);border-collapse:collapse;overflow-x:auto;border:1px solid var(--color-border-medium)}.codehilitetable pre{border:none}.codehilitetable tr{margin:0;padding:0;border:none}.codehilitetable pre{padding:0;margin:0}.linenos pre{padding-left:5px;padding-right:5px}.codehilite{}.page-title{margin:0}.nav{margin:-1rem -1rem 1rem -1rem;background:var(--color-highlight-medium);padding-top:1rem}.nav>span{padding:0 0.75rem 0.25rem 0.75rem;color:#fff;opacity:0.7}.nav a{display:inline-block;text-decoration:none;padding:0 0.75rem 0.25rem 0.75rem;color:#fff}.nav .nav--active{color:var(--color-highlight-medium);background:#fff}.logo{font-size:2rem;font-weight:normal}.metadata{font-size:0.8rem;color:var(--color-text-light)}.italic{font-style:italic}.admonition{margin:0.5rem 0;padding:0.5rem 1rem 0.25rem 1rem}.admonition-title{font-weight:bold;margin:0 -1rem;padding:0.3em 1rem}.note{color:#28a745;background:#28a74520}.caution{color:#ff073a;background:#e2302820}.important{color:#201aa2;background:#007bff20}.codehilite .hll{background-color:#ffffcc}.codehilite{background:#f8f8f8}.codehilite .c{color:#8f5902;font-style:italic}.codehilite .err{color:#a40000;border:1px solid #ef2929}.codehilite .g{color:#000000}.codehilite .k{color:#204a87;font-weight:bold}.codehilite .l{color:#000000}.codehilite .n{color:#000000}.codehilite .o{color:#ce5c00;font-weight:bold}.codehilite .x{color:#000000}.codehilite .p{color:#000000;font-weight:bold}.codehilite .ch{color:#8f5902;font-style:italic}.codehilite .cm{color:#8f5902;font-style:italic}.codehilite .cp{color:#8f5902;font-style:italic}.codehilite .cpf{color:#8f5902;font-style:italic}.codehilite .c1{color:#8f5902;font-style:italic}.codehilite .cs{color:#8f5902;font-style:italic}.codehilite .gd{color:#a40000}.codehilite .ge{color:#000000;font-style:italic}.codehilite .gr{color:#ef2929}.codehilite .gh{color:#000080;font-weight:bold}.codehilite .gi{color:#00A000}.codehilite .go{color:#000000;font-style:italic}.codehilite .gp{color:#8f5902}.codehilite .gs{color:#000000;font-weight:bold}.codehilite .gu{color:#800080;font-weight:bold}.codehilite .gt{color:#a40000;font-weight:bold}.codehilite .kc{color:#204a87;font-weight:bold}.codehilite .kd{color:#204a87;font-weight:bold}.codehilite .kn{color:#204a87;font-weight:bold}.codehilite .kp{color:#204a87;font-weight:bold}.codehilite .kr{color:#204a87;font-weight:bold}.codehilite .kt{color:#204a87;font-weight:bold}.codehilite .ld{color:#000000}.codehilite .m{color:#0000cf;font-weight:bold}.codehilite .s{color:#4e9a06}.codehilite .na{color:#c4a000}.codehilite .nb{color:#204a87}.codehilite .nc{color:#000000}.codehilite .no{color:#000000}.codehilite .nd{color:#5c35cc;font-weight:bold}.codehilite .ni{color:#ce5c00}.codehilite .ne{color:#cc0000;font-weight:bold}.codehilite .nf{color:#000000}.codehilite .nl{color:#f57900}.codehilite .nn{color:#000000}.codehilite .nx{color:#000000}.codehilite .py{color:#000000}.codehilite .nt{color:#204a87;font-weight:bold}.codehilite .nv{color:#000000}.codehilite .ow{color:#204a87;font-weight:bold}.codehilite .w{color:#f8f8f8;text-decoration:underline}.codehilite .mb{color:#0000cf;font-weight:bold}.codehilite .mf{color:#0000cf;font-weight:bold}.codehilite .mh{color:#0000cf;font-weight:bold}.codehilite .mi{color:#0000cf;font-weight:bold}.codehilite .mo{color:#0000cf;font-weight:bold}.codehilite .sa{color:#4e9a06}.codehilite .sb{color:#4e9a06}.codehilite .sc{color:#4e9a06}.codehilite .dl{color:#4e9a06}.codehilite .sd{color:#8f5902;font-style:italic}.codehilite .s2{color:#4e9a06}.codehilite .se{color:#4e9a06}.codehilite .sh{color:#4e9a06}.codehilite .si{color:#4e9a06}.codehilite .sx{color:#4e9a06}.codehilite .sr{color:#4e9a06}.codehilite .s1{color:#4e9a06}.codehilite .ss{color:#4e9a06}.codehilite .bp{color:#3465a4}.codehilite .fm{color:#000000}.codehilite .vc{color:#000000}.codehilite .vg{color:#000000}.codehilite .vi{color:#000000}.codehilite .vm{color:#000000}.codehilite .il{color:#0000cf;font-weight:bold}.header{display:block;margin-top:2rem;margin-bottom:3rem;clear:both;color:var(--color-text-medium)}.centrecolumn{background:var(--color-foreground);float:left;width:70%;box-shadow:0 0 1.25rem rgba(0,0,0,0.1);padding:1rem;z-index:2}.rightcolumn{float:left;width:30%;margin:0;position:sticky;top:1rem;z-index:1}.card{padding:1rem}.rightcolumn span{color:var(--color-text-light);padding-left:1rem}.toc{max-height:90vh;overflow-y:auto;padding:0 0 0 1rem}.toc ul{list-style-type:none;padding-left:1rem}.toc>ul{padding-left:0;margin-top:0}.toc>ul>li a{display:inline-block;padding:0.2rem}.toc>ul ul{}.toc a{text-decoration:none}.row:after{content:"";display:table;clear:both}#btntoc{display:none}@media screen and (max-width:992px){}@media screen and (max-width:768px){.centrecolumn,.rightcolumn{width:100%;margin:1% 0 0 0}.toc{position:fixed;bottom:0;left:0;z-index:998;background:var(--color-foreground);box-shadow:0 -0.25rem 0.6rem rgba(0,0,0,0.1);width:100%;padding:1rem;max-height:90vh;overflow-y:auto}#btntoc{display:inline-block;position:fixed;bottom:1rem;right:1rem;z-index:999;padding:0.5rem 1.25rem 0.5rem 1.25rem;background:var(--color-button-yellow);border:none;box-shadow:0 0.25rem 0.6rem rgba(0,0,0,0.3)}}@media screen and (max-width:576px){}
    </style>
    <script>
        /*! instant.page v5.1.0 - (C) 2019-2020 Alexandre Dieulot - https://instant.page/license */
        let t,e;const n=new Set,o=document.createElement("link"),i=o.relList&&o.relList.supports&&o.relList.supports("prefetch")&&window.IntersectionObserver&&"isIntersecting"in IntersectionObserverEntry.prototype,s="instantAllowQueryString"in document.body.dataset,a="instantAllowExternalLinks"in document.body.dataset,r="instantWhitelist"in document.body.dataset,c="instantMousedownShortcut"in document.body.dataset,d=1111;let l=65,u=!1,f=!1,m=!1;if("instantIntensity"in document.body.dataset){const t=document.body.dataset.instantIntensity;if("mousedown"==t.substr(0,"mousedown".length))u=!0,"mousedown-only"==t&&(f=!0);else if("viewport"==t.substr(0,"viewport".length))navigator.connection&&(navigator.connection.saveData||navigator.connection.effectiveType&&navigator.connection.effectiveType.includes("2g"))||("viewport"==t?document.documentElement.clientWidth*document.documentElement.clientHeight<45e4&&(m=!0):"viewport-all"==t&&(m=!0));else{const e=parseInt(t);isNaN(e)||(l=e)}}if(i){const n={capture:!0,passive:!0};if(f||document.addEventListener("touchstart",function(t){e=performance.now();const n=t.target.closest("a");if(!h(n))return;v(n.href)},n),u?c||document.addEventListener("mousedown",function(t){const e=t.target.closest("a");if(!h(e))return;v(e.href)},n):document.addEventListener("mouseover",function(n){if(performance.now()-e<d)return;const o=n.target.closest("a");if(!h(o))return;o.addEventListener("mouseout",p,{passive:!0}),t=setTimeout(()=>{v(o.href),t=void 0},l)},n),c&&document.addEventListener("mousedown",function(t){if(performance.now()-e<d)return;const n=t.target.closest("a");if(t.which>1||t.metaKey||t.ctrlKey)return;if(!n)return;n.addEventListener("click",function(t){1337!=t.detail&&t.preventDefault()},{capture:!0,passive:!1,once:!0});const o=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1,detail:1337});n.dispatchEvent(o)},n),m){let t;(t=window.requestIdleCallback?t=>{requestIdleCallback(t,{timeout:1500})}:t=>{t()})(()=>{const t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const n=e.target;t.unobserve(n),v(n.href)}})});document.querySelectorAll("a").forEach(e=>{h(e)&&t.observe(e)})})}}function p(e){e.relatedTarget&&e.target.closest("a")==e.relatedTarget.closest("a")||t&&(clearTimeout(t),t=void 0)}function h(t){if(t&&t.href&&(!r||"instant"in t.dataset)&&(a||t.origin==location.origin||"instant"in t.dataset)&&["http:","https:"].includes(t.protocol)&&("http:"!=t.protocol||"https:"!=location.protocol)&&(s||!t.search||"instant"in t.dataset)&&!(t.hash&&t.pathname+t.search==location.pathname+location.search||"noInstant"in t.dataset))return!0}function v(t){if(n.has(t))return;const e=document.createElement("link");e.rel="prefetch",e.href=t,document.head.appendChild(e),n.add(t)}
    </script>
</head>

<body>
    <div class="row">
        <div class="header">
            <span class="logo">UseNir</span>
            by Niraj Zade
        </div>
    </div>
    <div class="row">
        <div class="centrecolumn">
            <div class="nav">
                <span>Sections</span><a href="index.html">INDEX</a><a class="nav--active" href="index.html#essays">ESSAYS</a><a href="index.html#notes">NOTES</a><a href="index.html#guides">GUIDES</a>
            </div>

            <!-- title -->
            <h1 class="page-title">Flask done from zero to tonight</h1>
            <!-- description -->
            <span class="italic">get going with flask from zero to tonight</span>
            <hr>

            <!-- category -->
            <!-- <span class="">zero to tonight</span> &nbsp; -->

            <!-- tags -->
            <span class="metadata">tags: </span>
            
                <span class="metadata italic">programming&nbsp;</span> 
            
                <span class="metadata italic">flask&nbsp;</span> 
            
                <span class="metadata italic">python&nbsp;</span> 
            
                <span class="metadata italic">notes&nbsp;</span> 
            
            <br>
            <!-- date -->
            <span class="metadata">modified: </span>
            
                <span class="metadata italic">20 May 2021 &nbsp;</span>
            
                <span class="metadata italic">22 May 2021 &nbsp;</span>
            
            <br>
            <span class="metadata">last modified: </span>
            <span class="metadata italic">22 May 2021</span>
            <hr>

                <div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is currently a simple info dump. Organization into progressive steps is pending.</p>
</div>
<blockquote>
<p>The navy uses Django, pirates use flask</p>
</blockquote>
<p>A basic complete flask application</p>
<div class="codehilite"><pre><span></span><span class="n">form</span> <span class="n">flask</span> <span class="kn">import</span> <span class="nn">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span> <span class="o">|</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello World&lt;/h1&gt;&#39;</span>
</pre></div>


<h1 id="cli-commands">Cli commands</h1>
<p><strong>Run a server:</strong></p>
<div class="codehilite"><pre><span></span><span class="c1"># linux, mac    </span>
$ <span class="nb">export</span> <span class="nv">FLASK_APP</span><span class="o">=</span>hello.py
$ flask run

<span class="c1"># windows</span>
$ <span class="nb">set</span> <span class="nv">FLASK_APP</span><span class="o">=</span>hello.py
$ flask run
</pre></div>


<p><strong>Debug mode</strong></p>
<div class="codehilite"><pre><span></span><span class="c1"># run before `flask run`</span>
<span class="err">$</span> <span class="n">export</span> <span class="n">FLASK_DEBUG</span><span class="o">=</span><span class="mi">1</span>
</pre></div>


<p><strong>Get app Urls</strong>*</p>
<div class="codehilite"><pre><span></span><span class="err">$</span> <span class="n">python</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">hello</span> <span class="kn">import</span> <span class="n">app</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">url_map</span>
</pre></div>


<h1 id="configuration">Configuration</h1>
<p>app.config is a general place to store configuration variables used by flask, extensions and the app itself.</p>
<div class="codehilite"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hard to guess string&#39;</span>
</pre></div>


<h1 id="routes">Routes</h1>
<p><strong>Static</strong></p>
<div class="codehilite"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span> <span class="o">|</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello World&lt;/h1&gt;&#39;</span>
</pre></div>


<p><strong>Dynamic</strong></p>
<div class="codehilite"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/user/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello, {}!&lt;/h1&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>


<h1 id="request-response-cycles">Request-response cycles</h1>
<p>Flask has 2 contexts: Aplication context and request context</p>
<table>
<thead>
<tr>
<th>var</th>
<th>context</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>current_app</td>
<td>app</td>
<td>app instance of current active app</td>
</tr>
<tr>
<td>g</td>
<td>app</td>
<td>temp var used while handling current request. reset with each request</td>
</tr>
<tr>
<td>request</td>
<td>request</td>
<td>request object</td>
</tr>
<tr>
<td>session</td>
<td>request</td>
<td>@user session, a dict to store values  rememebred between requests</td>
</tr>
</tbody>
</table>
<p>Request objects:</p>
<table>
<thead>
<tr>
<th>Attribute/Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>form</td>
<td>dictionary with all the form fields submitted with the request</td>
</tr>
<tr>
<td>args</td>
<td>dictionary with all the arguments passed in the query string of the URL</td>
</tr>
<tr>
<td>values</td>
<td>dictionary that combines the values in form and args</td>
</tr>
<tr>
<td>cookies</td>
<td>dictionary with all the cookies included in the request</td>
</tr>
<tr>
<td>headers</td>
<td>dictionary with all the HTTP headers included in the request</td>
</tr>
<tr>
<td>files</td>
<td>dictionary with all the file uploads included with the request</td>
</tr>
<tr>
<td>get_data</td>
<td></td>
</tr>
<tr>
<td>get_json</td>
<td></td>
</tr>
<tr>
<td>blueprint</td>
<td>name of the Flask blueprint that is handling the request. Blueprints are introduced in Chapter 7</td>
</tr>
<tr>
<td>endpoint</td>
<td>name of the Flask endpoint that is handling the request. Flask uses the name of the view function as the endpoint name for a route</td>
</tr>
<tr>
<td>method</td>
<td>HTTP request method, such as GET or POST</td>
</tr>
<tr>
<td>scheme</td>
<td>URL scheme ( http or https )</td>
</tr>
<tr>
<td>is_secure</td>
<td></td>
</tr>
<tr>
<td>host</td>
<td>host defined in the request, including the port number if given by the client</td>
</tr>
<tr>
<td>path</td>
<td>path portion of the URL</td>
</tr>
<tr>
<td>query_string</td>
<td>query string portion of the URL, as a raw binary value</td>
</tr>
<tr>
<td>full_path</td>
<td>path and query string portions of the URL</td>
</tr>
<tr>
<td>url</td>
<td>complete URL requested by the client</td>
</tr>
<tr>
<td>base_url</td>
<td>same as url , but without the query string component</td>
</tr>
<tr>
<td>remote_addr</td>
<td>the IP address of the client</td>
</tr>
<tr>
<td>environ</td>
<td>the raw WSGI environment dictionary for the request</td>
</tr>
</tbody>
</table>
<p>Request Hooks:</p>
<table>
<thead>
<tr>
<th>Hook</th>
<th>when</th>
</tr>
</thead>
<tbody>
<tr>
<td>before_request</td>
<td>function to run before each request</td>
</tr>
<tr>
<td>before_first_request</td>
<td></td>
</tr>
<tr>
<td>after_request</td>
<td>run only if no unhandled exceptions occured</td>
</tr>
<tr>
<td>teardown_request</td>
<td>run even if unhandled exceptions occured</td>
</tr>
</tbody>
</table>
<h1 id="responses">Responses</h1>
<p>return status code:</p>
<div class="codehilite"><pre><span></span><span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;html&lt;/h1&gt;&#39;</span><span class="p">,</span> <span class="mi">200</span>
</pre></div>


<p>response object:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>
<span class="o">...</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="s1">&#39;&lt;h1&gt;This doc is a cookie&lt;/h1&gt;&#39;</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s1">&#39;answer&#39;</span><span class="p">,</span><span class="s1">&#39;42&#39;</span><span class="p">)</span>
    <span class="k">return</span> 
<span class="o">...</span>
</pre></div>


<table>
<thead>
<tr>
<th>Attribute</th>
<th>Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>status_code</td>
<td>numeric HTTP status code</td>
</tr>
<tr>
<td>headers</td>
<td>dictionary-like object with all the headers that will be sent with the response</td>
</tr>
<tr>
<td>set_cookie</td>
<td></td>
</tr>
<tr>
<td>delete_cookie</td>
<td></td>
</tr>
<tr>
<td>content_length</td>
<td>length of the response body</td>
</tr>
<tr>
<td>content_type</td>
<td>media type of the response body</td>
</tr>
<tr>
<td>set_data</td>
<td></td>
</tr>
<tr>
<td>get_data</td>
<td></td>
</tr>
</tbody>
</table>
<p>Redirect response:</p>
<p>Can be created with a 3 valued return, or with a response object, or with redirect | helper function provided by flask</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span>
<span class="o">...</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;http://www.example.com&#39;</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>


<p>Abort:</p>
<p>Does not return control back to fuction; raises an exception.</p>
<div class="codehilite"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/user/&lt;id&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">load_user</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello, {}&lt;/h1&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>


<p>Custom error pages</p>
<div class="codehilite"><pre><span></span><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;404.html&#39;</span><span class="p">),</span> <span class="mi">404</span>
</pre></div>


<h1 id="jinja-templating">Jinja templating</h1>
<p>Rendering:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="o">...</span>
    <span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/user/&lt;name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;user.html&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>


<hr />
<p>Variables:</p>
<div class="codehilite"><pre><span></span><span class="x">&lt;!-- Plain variable --&gt;</span>
<span class="cp">{{</span> <span class="nv">variable_name</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">&lt;!-- Variable with filter --&gt;</span>
<span class="cp">{{</span> <span class="nv">name</span><span class="o">|</span><span class="nf">capitalize</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>


<p>filters are:</p>
<table>
<thead>
<tr>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
</tr>
</thead>
<tbody>
<tr>
<td>abs</td>
<td>float</td>
<td>lower</td>
<td>round</td>
</tr>
<tr>
<td>attr</td>
<td>forceescape</td>
<td>map</td>
<td>safe</td>
</tr>
<tr>
<td>trim</td>
<td>batch</td>
<td>format</td>
<td>max</td>
</tr>
<tr>
<td>select</td>
<td>truncate</td>
<td>capitalize</td>
<td>groupby</td>
</tr>
<tr>
<td>min</td>
<td>selectattr</td>
<td>unique</td>
<td>center</td>
</tr>
<tr>
<td>indent</td>
<td>pprint</td>
<td>slice</td>
<td>upper</td>
</tr>
<tr>
<td>default</td>
<td>int</td>
<td>random</td>
<td>sort</td>
</tr>
<tr>
<td>urlencode</td>
<td>dictsort</td>
<td>join</td>
<td>reject</td>
</tr>
<tr>
<td>string</td>
<td>urlize</td>
<td>escape</td>
<td>last</td>
</tr>
<tr>
<td>rejectattr</td>
<td>striptags</td>
<td>wordcount</td>
<td>filesizeformat</td>
</tr>
<tr>
<td>length</td>
<td>replace</td>
<td>sum</td>
<td>wordwrap</td>
</tr>
<tr>
<td>first</td>
<td>list</td>
<td>reverse</td>
<td>title</td>
</tr>
<tr>
<td>xmlattr</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Control structures:</p>
<div class="codehilite"><pre><span></span><span class="x">&lt;!-- if else --&gt;</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">users</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    ...</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    ...</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;!-- for --&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">element</span> <span class="k">in</span> <span class="nv">elements</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    ...</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;!-- macros --&gt;</span>
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">render_comment</span><span class="o">(</span><span class="nv">comment</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;li&gt;</span><span class="cp">{{</span> <span class="nv">comment</span> <span class="cp">}}</span><span class="x">&lt;/li&gt;</span>
<span class="cp">{%</span> <span class="k">endmacro</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;!-- macros can be imported form other files --&gt;</span>
<span class="cp">{%</span> <span class="k">import</span> <span class="s1">&#39;macros.html&#39;</span> <span class="k">as</span> <span class="nv">macros</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;!-- blocks --&gt;</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span><span class="x">   Index   </span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">head</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    ...</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    ...</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>


<h1 id="bootstrap-integration">Bootstrap integration</h1>
<p>Shell:</p>
<div class="codehilite"><pre><span></span><span class="c1"># installation</span>
$ pip install bootstrap
</pre></div>


<p>Python:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="o">...</span>
<span class="n">bootstrap</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>


<p>Html:</p>
<div class="codehilite"><pre><span></span><span class="x">&lt;!-- in html --&gt;</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;bootstrap/base.html&quot;</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;!-- use bootstrap classes below --&gt;</span>
<span class="x">&lt;div class=&quot;container&quot;&gt;</span>
<span class="x">    ...</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>


<table>
<thead>
<tr>
<th>block name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>doc</td>
<td>The entire HTML document</td>
</tr>
<tr>
<td>html_attribs</td>
<td>Attributes inside the html tag</td>
</tr>
<tr>
<td>html</td>
<td>The contents of the html tag</td>
</tr>
<tr>
<td>head</td>
<td>The contents of the head tag</td>
</tr>
<tr>
<td>title</td>
<td>The contents of the title tag</td>
</tr>
<tr>
<td>metas</td>
<td>The list of meta tags</td>
</tr>
<tr>
<td>styles</td>
<td>CSS definitions</td>
</tr>
<tr>
<td>body_attribs</td>
<td>Attributes inside the body tag</td>
</tr>
<tr>
<td>body</td>
<td>The contents of the body tag</td>
</tr>
<tr>
<td>navbar</td>
<td>User-defined navigation bar</td>
</tr>
<tr>
<td>content</td>
<td>User-defined page content</td>
</tr>
<tr>
<td>scripts</td>
<td>JavaScript declarations at the bottom of the document</td>
</tr>
</tbody>
</table>
<p>Urls:</p>
<p>Use flask's url_for() helper method</p>
<div class="codehilite"><pre><span></span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;john&#39;</span><span class="p">,</span><span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">returns</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">john</span>
<span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;john&#39;</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">returns</span> <span class="k">return</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">john</span><span class="err">?</span><span class="n">page</span><span class="o">=</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">version</span><span class="o">=</span><span class="mi">1</span>
</pre></div>


<h1 id="static-files">Static files</h1>
<p>Flask automatically supports routes for static files, defined as /static/filename</p>
<div class="codehilite"><pre><span></span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">head</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{{</span> <span class="nb">super</span><span class="o">()</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">&lt;link rel=&quot;shortcut icon&quot; href=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">&#39;static&#39;</span><span class="o">,</span> <span class="nv">filename</span><span class="o">=</span><span class="s1">&#39;favicon.ico&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">type=&quot;image/x-icon&quot;&gt;</span>
<span class="x">&lt;link rel=&quot;icon&quot; href=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">&#39;static&#39;</span><span class="o">,</span> <span class="nv">filename</span><span class="o">=</span><span class="s1">&#39;favicon.ico&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">type=&quot;image/x-icon&quot;&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>


<h1 id="temporal-localization">Temporal localization</h1>
<p>Installation:</p>
<div class="codehilite"><pre><span></span>$ pip install flask-moment
</pre></div>


<p>Usage:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">flask_moment</span>
<span class="n">moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>


<p>Flask-Moment implements:</p>
<p>format() , fromNow() , fromTime() , calendar() ,
valueOf() , and unix()</p>
<p><a href="https://momentjs.com/docs/#/displaying/">More info</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>flask-moment assumes timestamps handled by applications are in UTC</p>
</div>
<p>Example: </p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
    <span class="n">current_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">The</span> <span class="n">local</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">time</span> <span class="ow">is</span> <span class="p">{{</span> <span class="n">moment</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;LLL&#39;</span><span class="p">)</span> <span class="p">}}</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">That</span> <span class="n">was</span> <span class="p">{{</span> <span class="n">moment</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span><span class="o">.</span><span class="n">fromNow</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</pre></div>


<h1 id="forms">Forms</h1>
<div class="codehilite"><pre><span></span>$ pip install flask-wtf
</pre></div>


<p>Configuration:</p>
<div class="codehilite"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hard to guess string&#39;</span>
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>flask-wtf requires a secret key to be configured. It's used to protect against CSRF attacks.</p>
</div>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span><span class="o">-</span><span class="n">wtf</span> <span class="kn">import</span> <span class="nn">FlaskForm</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">SubmitField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span>
<span class="k">class</span> <span class="nc">NameForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;What is your name?&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s1">&#39;Submit&#39;</span><span class="p">)</span>
</pre></div>


<table>
<thead>
<tr>
<th>WTForms html field</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>BooleanField</td>
<td>checkbox with True and False values</td>
</tr>
<tr>
<td>DateField</td>
<td>datetime.date value in a given format</td>
</tr>
<tr>
<td>DateTimeField</td>
<td>datetime.datetime value in a given format</td>
</tr>
<tr>
<td>DecimalField</td>
<td>accepts a decimal.Decimal value</td>
</tr>
<tr>
<td>FileField</td>
<td>file upload field</td>
</tr>
<tr>
<td>MultipleFileField</td>
<td>multiple file upload field</td>
</tr>
<tr>
<td>HiddenField</td>
<td>hidden text field</td>
</tr>
<tr>
<td>FieldList</td>
<td>list of fields of a given type</td>
</tr>
<tr>
<td>FloatField</td>
<td>floating-point value</td>
</tr>
<tr>
<td>FormField</td>
<td>form embedded as a field in a container form</td>
</tr>
<tr>
<td>IntegerField</td>
<td>integer value</td>
</tr>
<tr>
<td>PasswordField</td>
<td>password text field</td>
</tr>
<tr>
<td>RadioField</td>
<td>list of radio buttons</td>
</tr>
<tr>
<td>SelectField</td>
<td>drop-down list of choices</td>
</tr>
<tr>
<td>SelectMultipleField</td>
<td>drop-down list of choices with multiple selection</td>
</tr>
<tr>
<td>SubmitField</td>
<td>form submission button</td>
</tr>
<tr>
<td>StringField</td>
<td>text field</td>
</tr>
<tr>
<td>TextAreaField</td>
<td>multiple-line text field</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>WTForms validator</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>DataRequired</td>
<td>validates that the field contains data after type conversion</td>
</tr>
<tr>
<td>Email</td>
<td>validates an email address</td>
</tr>
<tr>
<td>EqualTo</td>
<td>compares the values of two fields; useful when requesting a password to be entered twice for confirmation</td>
</tr>
<tr>
<td>InputRequired</td>
<td>validates that the field contains data before type conversion</td>
</tr>
<tr>
<td>IPAddress</td>
<td>validates an IPv4 network address</td>
</tr>
<tr>
<td>Length</td>
<td>validates the length of the string entered</td>
</tr>
<tr>
<td>MacAddress</td>
<td>validates a MAC address</td>
</tr>
<tr>
<td>NumberRange</td>
<td>validates that the value entered is within a numeric range</td>
</tr>
<tr>
<td>Optional</td>
<td>allows empty input in the field, skipping additional validators</td>
</tr>
<tr>
<td>Regexp</td>
<td>validates the input against a regular expression</td>
</tr>
<tr>
<td>URL</td>
<td>validates a URL</td>
</tr>
<tr>
<td>UUID</td>
<td>validates a UUID</td>
</tr>
<tr>
<td>AnyOf</td>
<td>validates that the input is one of a list of possible values</td>
</tr>
<tr>
<td>NoneOf</td>
<td>validates that the input is none of a list of possible values</td>
</tr>
</tbody>
</table>
<p>Html exmaple:</p>
<div class="codehilite"><pre><span></span><span class="x">&lt;form method=&quot;POST&quot;&gt;</span>
<span class="cp">{{</span> <span class="nv">form.hidden_tag</span><span class="o">()</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{{</span> <span class="nv">form.name.label</span> <span class="cp">}}</span><span class="x"> </span><span class="cp">{{</span> <span class="nv">form.name</span><span class="o">(</span><span class="nv">id</span><span class="o">=</span><span class="s1">&#39;my-text-field&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{{</span> <span class="nv">form.submit</span><span class="o">()</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">&lt;/form&gt;</span>
</pre></div>


<p>Can also use bootstrap extension as  ahigh level helper to easily create forms</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="kn">import</span> <span class="s2">&quot;bootstrap/wtf.html&quot;</span> <span class="k">as</span> <span class="n">wtf</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{{</span> <span class="n">wtf</span><span class="o">.</span><span class="n">quick_form</span><span class="p">(</span><span class="n">form</span><span class="p">)</span> <span class="p">}}</span>
</pre></div>


<p>Render the form, and recieve data entered by the user</p>
<div class="codehilite"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span>
    <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When methods is not given, the view function is registered to handle GET requests only.</p>
</div>
<h1 id="user-sessions">User sessions</h1>
<p>An encrypted client cookie is used to maintain sessions</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
</pre></div>


<p><strong>Flashing changes:</strong></p>
<p>Use the flash() method</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">old_name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">old_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">old_name</span> <span class="o">!=</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Looks like you have changed your name!&#39;</span><span class="p">)</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">html</span> <span class="o">--&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">content</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;container&quot;</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">get_flashed_messages</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>
            <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;alert alert-warning&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">button</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;button&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;close&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">dismiss</span><span class="o">=</span><span class="s2">&quot;alert&quot;</span><span class="o">&gt;&amp;</span><span class="n">times</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
                <span class="p">{{</span> <span class="n">message</span> <span class="p">}}</span>
            <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">page_content</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
</pre></div>


<h1 id="databases">Databases</h1>
<div class="codehilite"><pre><span></span>$ pip install flask-sqlalchemy
</pre></div>


<table>
<thead>
<tr>
<th>DB engine</th>
<th>URL</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySQL</td>
<td>mysql://username:password@hostname/database</td>
</tr>
<tr>
<td>Postgres</td>
<td>postgresql://username:password@hostname/database</td>
</tr>
<tr>
<td>SQLite</td>
<td>(Linux, macOS) sqlite:////absolute/path/to/database</td>
</tr>
</tbody>
</table>
<p>Db configuration:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span>\
    <span class="s1">&#39;sqlite:///&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;data.sqlite&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>


<p>Defining models:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;roles&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;Role </span><span class="si">%r</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>


<p>Common SQLAlchemy column types:</p>
<table>
<thead>
<tr>
<th>SQLAlchemy type</th>
<th>python type</th>
<th>desc</th>
</tr>
</thead>
<tbody>
<tr>
<td>integer</td>
<td>int</td>
<td>regular integer, typically 32 bits</td>
</tr>
<tr>
<td>smallinteger</td>
<td>int</td>
<td>short-range integer, typically 16 bits</td>
</tr>
<tr>
<td>biginteger</td>
<td>int or long</td>
<td>unlimited precision integer</td>
</tr>
<tr>
<td>float</td>
<td>float</td>
<td>floating-point number</td>
</tr>
<tr>
<td>numeric</td>
<td>decimal.decimal</td>
<td>fixed-point number</td>
</tr>
<tr>
<td>string</td>
<td>str</td>
<td>variable-length string</td>
</tr>
<tr>
<td>text</td>
<td>str</td>
<td>variable-length string, optimized for large or unbounded length</td>
</tr>
<tr>
<td>unicode</td>
<td>unicode</td>
<td>variable-length unicode string</td>
</tr>
<tr>
<td>unicodetext</td>
<td>unicode</td>
<td>variable-length unicode string, optimized for large or unbounded length</td>
</tr>
<tr>
<td>boolean</td>
<td>bool</td>
<td>boolean value</td>
</tr>
<tr>
<td>date</td>
<td>datetime.date</td>
<td>date value</td>
</tr>
<tr>
<td>time</td>
<td>datetime.time</td>
<td>time value</td>
</tr>
<tr>
<td>datetime</td>
<td>datetime.datetime</td>
<td>date and time value</td>
</tr>
<tr>
<td>interval</td>
<td>datetime.timedelta</td>
<td>time interval</td>
</tr>
<tr>
<td>enum</td>
<td>str</td>
<td>list of string values</td>
</tr>
<tr>
<td>pickletype</td>
<td>any python object</td>
<td>automatic pickle serialization</td>
</tr>
<tr>
<td>largebinary</td>
<td>str</td>
<td>binary blob</td>
</tr>
</tbody>
</table>
<p>Common SQLAlchemy column options</p>
<table>
<thead>
<tr>
<th>Option name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>primary_key</td>
<td>if set to true, the column is the table’s primary key</td>
</tr>
<tr>
<td>unique</td>
<td>if set to true, do not allow duplicate values for this column</td>
</tr>
<tr>
<td>index</td>
<td>if set to true, create an index for this column, so that queries are more efficient</td>
</tr>
<tr>
<td>nullable</td>
<td>if set to true, allow empty values for this column. if set to false , the column will not allow null values</td>
</tr>
<tr>
<td>default</td>
<td>define a default value for the column</td>
</tr>
</tbody>
</table>
<p>Relationships:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;role&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">role_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;roles.id&#39;</span><span class="p">))</span>
</pre></div>


<p>Common SQLAlchemy relation options</p>
<table>
<thead>
<tr>
<th>option</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>backref</td>
<td>Add a back reference in the other model in the relationship</td>
</tr>
<tr>
<td>primaryjoin</td>
<td>Specify the join condition between the two models explicitly. This is necessary only for ambiguous relationships</td>
</tr>
<tr>
<td>lazy</td>
<td>Specify how the related items are to be loaded. Possible values are select (items are loaded on demand the first time they are accessed), immediate (items are loaded when the source object is loaded), joined (items are loaded immediately, but as a join), subquery (items are loaded immediately, but as a subquery), noload (items are never loaded), and dynamic (instead of loading the items, the query that can load them is given)</td>
</tr>
<tr>
<td>uselist</td>
<td>If set to False , use a scalar instead of a list</td>
</tr>
<tr>
<td>order_by</td>
<td>Specify the ordering used for the items in the relationship</td>
</tr>
<tr>
<td>secondary</td>
<td>Specify the name of the association table to use in many-to-many relationships</td>
</tr>
<tr>
<td>secondaryjoin</td>
<td>Specify the secondary join condition for many-to-many relationships when SQLAlchemy cannot determine it on its own</td>
</tr>
</tbody>
</table>
<h2 id="database-operations">Database operations</h2>
<div class="codehilite"><pre><span></span><span class="err">$</span> <span class="n">flask</span> <span class="n">shell</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">hello</span> <span class="kn">import</span> <span class="n">db</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
</pre></div>


<p>Inserting rows:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">hello</span> <span class="kn">import</span> <span class="n">Role</span><span class="p">,</span> <span class="n">User</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">admin_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Admin&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mod_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Moderator&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">user_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;User&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">user_john</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;john&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">admin_role</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">user_susan</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;susan&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">user_role</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">user_david</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;david&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">user_role</span><span class="p">)</span>
</pre></div>


<p>Changes are managed through <code>db.session</code>. To prepare objects to be written to database, they must be added to the session</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">admin_role</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mod_role</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user_role</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user_john</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user_susan</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user_david</span><span class="p">)</span>
</pre></div>


<p>or</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">admin_role</span><span class="p">,</span> <span class="n">mod_role</span><span class="p">,</span> <span class="n">user_role</span><span class="p">,</span>
    <span class="o">...</span>
    <span class="n">user_john</span><span class="p">,</span> <span class="n">user_susan</span><span class="p">,</span> <span class="n">user_david</span><span class="p">])</span>
</pre></div>


<p>Commit:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Database session are also called transactions. They are not related to flask sessions.</p>
</div>
<p>Modify row:</p>
<p>Rename Admin role to Administrator</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">admin_role</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Administrator&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">admin_role</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>


<p>Delete row:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">mod_role</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>


<p>Query row:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">User</span> <span class="s1">&#39;john&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span> <span class="s1">&#39;susan&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span> <span class="s1">&#39;david&#39;</span><span class="o">&gt;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">user_role</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">User</span> <span class="s1">&#39;susan&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span> <span class="s1">&#39;david&#39;</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>


<p>To inspect query generated by SQLAlchemy:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">user_role</span><span class="p">))</span>
<span class="s1">&#39;SELECT users.id AS users_id, users.username AS users_username,</span>
<span class="n">users</span><span class="o">.</span><span class="n">role_id</span> <span class="n">AS</span> <span class="n">users_role_id</span> \<span class="n">nFROM</span> <span class="n">users</span> \<span class="n">nWHERE</span> <span class="p">:</span><span class="n">param_1</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">role_id</span><span class="s1">&#39;</span>
</pre></div>


<p>Common query filters</p>
<table>
<thead>
<tr>
<th>filter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>filter()</td>
<td>returns a new query that adds an additional filter to the original query</td>
</tr>
<tr>
<td>filter_by()</td>
<td>returns a new query that adds an additional equality filter to the original query</td>
</tr>
<tr>
<td>limit()</td>
<td>returns a new query that limits the number of results of the original query to the given number</td>
</tr>
<tr>
<td>offset()</td>
<td>returns a new query that applies an offset into the list of results of the original query</td>
</tr>
<tr>
<td>order_by()</td>
<td>returns a new query that sorts the results of the original query according to the given criteria</td>
</tr>
<tr>
<td>group_by()</td>
<td>returns a new query that groups the results of the original query according to the given criteria</td>
</tr>
</tbody>
</table>
<p>Common query executors</p>
<table>
<thead>
<tr>
<th>executor</th>
<th>desc</th>
</tr>
</thead>
<tbody>
<tr>
<td>all()</td>
<td>Returns all the results of a query as a list</td>
</tr>
<tr>
<td>first()</td>
<td>Returns the first result of a query, or None if there are no results</td>
</tr>
<tr>
<td>first_or_404()</td>
<td>Returns the first result of a query, or aborts the request and sends a 404 error as the response if there are no results</td>
</tr>
<tr>
<td>get()</td>
<td>Returns the row that matches the given primary key, or None if no matching row is found</td>
</tr>
<tr>
<td>get_or_404()</td>
<td>Returns the row that matches the given primary key or, if the key is not found, aborts the request and sends a 404 error as the response</td>
</tr>
<tr>
<td>count()</td>
<td>Returns the result count of the query</td>
</tr>
<tr>
<td>paginate()</td>
<td>Returns a Pagination object that contains the specified range of results</td>
</tr>
</tbody>
</table>
<p>Dynamic database relationships:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>


<p>Why?</p>
<p>With the relationship configured in this way, user_role.users returns a query that hasn’t executed yet, so filters can be added to it:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">user_role</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">User</span> <span class="s1">&#39;david&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span> <span class="s1">&#39;susan&#39;</span><span class="o">&gt;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">user_role</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="mi">2</span>
</pre></div>


<p>Database Use in View Functions</p>
<div class="codehilite"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">U12</span><span class="s1">&#39;known&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;known&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span>
        <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
        <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
        <span class="n">known</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;known&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
</pre></div>


<p>Html example: using known argument to customize greeting</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="kn">import</span> <span class="s2">&quot;bootstrap/wtf.html&quot;</span> <span class="k">as</span> <span class="n">wtf</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">title</span> <span class="o">%</span><span class="p">}</span><span class="n">Flasky</span><span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">page_content</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;page-header&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Hello</span><span class="p">,</span> <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">name</span> <span class="o">%</span><span class="p">}{{</span> <span class="n">name</span> <span class="p">}}{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span><span class="n">Stranger</span><span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span><span class="err">!</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
    <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">known</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Pleased</span> <span class="n">to</span> <span class="n">meet</span> <span class="n">you</span><span class="err">!</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
    <span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Happy</span> <span class="n">to</span> <span class="n">see</span> <span class="n">you</span> <span class="n">again</span><span class="err">!</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="p">{{</span> <span class="n">wtf</span><span class="o">.</span><span class="n">quick_form</span><span class="p">(</span><span class="n">form</span><span class="p">)</span> <span class="p">}}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
</pre></div>


<h1 id="database-migrations-with-flask-migrate">Database Migrations with Flask-Migrate</h1>
<div class="codehilite"><pre><span></span>$ pip install flask-migrate

from flask_migrate import Migrate
<span class="c1"># ...</span>
<span class="nv">migrate</span> <span class="o">=</span> Migrate<span class="o">(</span>app, db<span class="o">)</span>
</pre></div>


<p>Add support for database migrations with the init subcommand:</p>
<div class="codehilite"><pre><span></span>$ flask db init
    Creating directory /home/flask/flasky/migrations...done
    Creating directory /home/flask/flasky/migrations/versions...done
    Generating /home/flask/flasky/migrations/alembic.ini...done
    Generating /home/flask/flasky/migrations/env.py...done
    Generating /home/flask/flasky/migrations/env.pyc...done
    Generating /home/flask/flasky/migrations/README...done
    Generating /home/flask/flasky/migrations/script.py.mako...done
    Please edit configuration/connection/logging settings in
    <span class="s1">&#39;/home/flask/flasky/migrations/alembic.ini&#39;</span> before proceeding.
</pre></div>


<p>This command creates a migrations directory, where all the migration scripts will be stored.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The files in a database migration repository must always be added to version control along with the rest of the application.</p>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Automatic migrations are not always accurate and can miss some details that are ambiguous. For example, if a column is renamed, an automatically generated migration may show that the column in question was deleted and a new column was added with the new name. Leaving the migration as is will cause the data in this column to be lost! For this reason, migration scripts generated automati‐ cally should always be reviewed and manually corrected if they have any inaccuracies.</p>
</div>
<ol>
<li>Make the necessary changes to the model classes.</li>
<li>Create an automatic migration script with the flask db migrate command.</li>
<li>Review the generated script and adjust it so that it accurately represents the changes that were made to the models.</li>
<li>Add the migration script to source control.</li>
<li>Apply the migration to the database with the flask db upgrade command.</li>
</ol>
<p>Create migraitons script</p>
<div class="codehilite"><pre><span></span>$ flask db migrate -m <span class="s2">&quot;initial migration&quot;</span>
    INFO <span class="o">[</span>alembic.migration<span class="o">]</span> Context impl SQLiteImpl.
    INFO <span class="o">[</span>alembic.migration<span class="o">]</span> Will assume non-transactional DDL.
    INFO <span class="o">[</span>alembic.autogenerate<span class="o">]</span> Detected added table <span class="s1">&#39;roles&#39;</span>
    INFO <span class="o">[</span>alembic.autogenerate<span class="o">]</span> Detected added table <span class="s1">&#39;users&#39;</span>
    INFO <span class="o">[</span>alembic.autogenerate.compare<span class="o">]</span> Detected added index
    <span class="s1">&#39;ix_users_username&#39;</span> on <span class="s1">&#39;[&#39;</span>username<span class="s1">&#39;]&#39;</span>
    Generating /home/flask/flasky/migrations/versions/1bc
    594146bb5_initial_migration.py...done
</pre></div>


<p>Upgrade:</p>
<div class="codehilite"><pre><span></span>$ flask db upgrade
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have been working with the application in its previous stages, you already have a database file that was created with the db.create_all() function earlier. In this state, the flask db upgrade will fail because it will try to create database tables that already exist. A simple way to address this problem is to delete your data.sqlite database file and then run flask db upgrade to generate a new database through the migration framework. Another option is to skip the flask db upgrade and instead mark the existing database as upgraded using the flask db stamp com‐ mand.</p>
</div>
<p>Adding more migrations:</p>
<ol>
<li>Make the necessary changes in the database models.</li>
<li>Generate a migration with the flask db migrate command.</li>
<li>Review the generated migration script and correct it if it has any inaccuracies.</li>
<li>Apply the changes to the database with the flask db upgrade command.</li>
</ol>
<p>To expand the last migration script:</p>
<ol>
<li>Remove the last migration from the database with the flask db downgrade com‐ mand (note that this may cause some data to be lost).</li>
<li>Delete the last migration script, which is now orphaned.</li>
<li>Generate a new database migration with the flask db migrate command, which will now include the changes in the migration script you just removed, plus any other changes you’ve made to the models.</li>
<li>Review and apply the migration script as described previously.</li>
</ol>
<h1 id="todo-large-application-structure">ToDo: Large application structure</h1>
            
        </div>
        <div class="rightcolumn">
            <span>Contents</span>
                <div class="toc">
<ul>
<li><a href="#cli-commands">Cli commands</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#routes">Routes</a></li>
<li><a href="#request-response-cycles">Request-response cycles</a></li>
<li><a href="#responses">Responses</a></li>
<li><a href="#jinja-templating">Jinja templating</a></li>
<li><a href="#bootstrap-integration">Bootstrap integration</a></li>
<li><a href="#static-files">Static files</a></li>
<li><a href="#temporal-localization">Temporal localization</a></li>
<li><a href="#forms">Forms</a></li>
<li><a href="#user-sessions">User sessions</a></li>
<li><a href="#databases">Databases</a><ul>
<li><a href="#database-operations">Database operations</a></li>
</ul>
</li>
<li><a href="#database-migrations-with-flask-migrate">Database Migrations with Flask-Migrate</a></li>
<li><a href="#todo-large-application-structure">ToDo: Large application structure</a></li>
</ul>
</div>

        </div>
    </div>
    <button id="btntoc">Index</button>


    
    
</body>

</html>